<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Mimoza</title>
    <link rel="stylesheet" href="public/tab/dist/css/tabulator_simple.css" />
    <link href="public/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>

  <body class="bg-body-secondary">
    <nav
      class="navbar navbar-expand-sm bg-dark sticky-top"
      data-bs-theme="dark"
    >
      <div class="container-fluid">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo03"
          aria-controls="navbarTogglerDemo03"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggl/e/r-ic/o/n">placeholder</span>
        </button>
        <a class="navbar-brand" href="#"
          ><img
            src="./assets/logo.svg"
            width="100px"
            class="d-none d-xl-block"
          />
        </a>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item d-flex align-items-center">
              <a id="index" class="nav-link active" aria-current="page" href="#"
                ><i class="fa-solid fa-calendar" style="color: #ffffff"></i>
                Reservations |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a id="charges" class="nav-link" href="charges.html"
                ><i
                  class="fa-solid fa-comment-dollar"
                  style="color: #ffffff"
                ></i>
                Charges |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a id="credits" class="nav-link" href="credits.html">
                <i class="fa-solid fa-coins" style="color: #ffffff"></i>

                Crédits |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a id="avances" class="nav-link" href="avances.html">
                <i
                  class="fa-solid fa-hand-holding-dollar"
                  style="color: #ffffff"
                ></i>
                Avances |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a id="cars" class="nav-link" href="cars.html">
                <i class="fa-solid fa-car-side" style="color: #ffffff"></i>
                Park |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a id="clients" class="nav-link" href="clients.html">
                <i class="fa-solid fa-person" style="color: #ffffff"></i>
                Clients |
              </a>
            </li>
          </ul>
          <span class="text-white" id="navbarList"></span>
          <a id="infos" href="infos.html"
            ><i class="fa-solid fa-circle-info mx-2" style="color: #ffffff"></i
          ></a>
        </div>
      </div>
    </nav>

    <div class="px-4">
      <h1 class="mt-4">Reservations :</h1>
      <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item fs-3 active"></li>
      </ol>
    </div>

    <hr />
    <div class="container-fluid shadow">
      <div id="table"></div>
    </div>

    <div class="container-fluid d-flex justify-content-end mt-2 mb-5">
      <button id="addRow" class="btn btn-success">+ Ajouter</button>
    </div>
    <div class="fixed-bottom bg-dark px-3 d-flex justify-content-between">
      <ul class="nav nav-underline" data-bs-theme="dark">
        <li class="nav-item footer">
          <a data-month="01" class="nav-link" href="#">Janvier</a>
        </li>
        <li class="nav-item footer">
          <a data-month="02" class="nav-link" href="#">Février</a>
        </li>
        <li class="nav-item footer">
          <a data-month="03" class="nav-link" href="#">Mars</a>
        </li>
        <li class="nav-item footer">
          <a data-month="04" class="nav-link" href="#">Avril</a>
        </li>
        <li class="nav-item footer">
          <a data-month="05" class="nav-link" href="#">Mai</a>
        </li>
        <li class="nav-item footer">
          <a data-month="06" class="nav-link" href="#">Juin</a>
        </li>
        <li class="nav-item footer">
          <a data-month="07" class="nav-link" href="#">Juillet</a>
        </li>
        <li class="nav-item footer">
          <a data-month="08" class="nav-link" href="#">Août</a>
        </li>
        <li class="nav-item footer">
          <a data-month="09" class="nav-link" href="#">Septembre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="10" class="nav-link" href="#">Octobre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="11" class="nav-link" href="#">Novembre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="12" class="nav-link" href="#">Décembre</a>
        </li>
      </ul>

      <div class="btn-group dropup">
        <button
          type="button"
          class="btn btn-dark dropdown-toggle"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          2024
        </button>
        <ul class="dropdown-menu dropdown-menu-dark">
          <li><a data-year="2026" class="dropdown-item" href="#">2026</a></li>
          <li><a data-year="2025" class="dropdown-item" href="#">2025</a></li>
          <li><a data-year="2024" class="dropdown-item" href="#">2024</a></li>
          <li><a data-year="2023" class="dropdown-item" href="#">2023</a></li>
        </ul>
      </div>
    </div>

    <script src="public/popper.js"></script>
    <script src="public/bootstrap/dist/js/bootstrap.js"></script>
    <script src="public/luxon.js"></script>
    <script src="public/tab/dist/js/tabulator.js"></script>
    <script>
      var urlParams = new URLSearchParams(window.location.search);
      let monthString, yearString;

      if (urlParams.get("month") != null) {
        // Get the value of the "month" parameter
        monthString = urlParams.get("month");
        // Get the value of the "year" parameter
        yearString = urlParams.get("year");
        console.log("TravelData", monthString, yearString);
      } else {
        console.log("NEW APP");
        const currentDate = new Date();
        const localMonth = currentDate.getMonth() + 1;
        const localYear = currentDate.getFullYear();

        monthString =
          localMonth < 10 ? "0" + localMonth : localMonth.toString();
        yearString = localYear.toString();
        console.log(monthString, yearString);
      }

      function numericMonthToName(numericMonth) {
        const months = [
          "Janvier",
          "Février",
          "Mars",
          "Avril",
          "Mai",
          "Juin",
          "Juillet",
          "Août",
          "Septembre",
          "Octobre",
          "Novembre",
          "Décembre",
        ];
        const index = parseInt(numericMonth, 10) - 1;
        return months[index];
      }

      //title
      const title = document.querySelector(".breadcrumb-item");

      document.addEventListener("DOMContentLoaded", function () {
        console.log(monthString, yearString);
        let reservations = window.api.getReservations(monthString, yearString);
        let cars = window.api.getCarsCodes();
        let clients = window.api.getClients();

        const cars_codes = cars.map((car) => car.code);
        console.log(cars_codes);
        title.innerHTML = numericMonthToName(monthString) + " " + yearString;
        console.log(reservations);
        //Making the current month active
        const activeMonth = document.querySelector(
          `a[data-month="${monthString}"]`
        );
        activeMonth.classList.add("active");
        let selectedMonth = monthString;
        let selectedYear = yearString;
        // Display the selected year in the dropdown
        const displayedYear = document.querySelector(".dropdown-toggle");
        displayedYear.innerHTML = yearString;

        document
          .getElementById("addRow")
          .addEventListener("click", function () {
            table.addRow({
              caisse: 0,
              credit: 0,
              prix: 0,
              n_jr: 0,
              montant: 0,
            });
          });

        var rowMenu = [
          {
            label: "🟦 Meknes",
            action: function (e, row) {
              window.api.updateReservations(
                row.getData().id,
                "status",
                "Meknes"
              );
              row.getElement().style.backgroundColor = "#a9d2f0";
            },
          },
          {
            label: "⬜ A retourner",
            action: function (e, row) {
              window.api.updateReservations(
                row.getData().id,
                "status",
                "A retourner"
              );

              row.getElement().style.backgroundColor = "";
            },
          },
          {
            label: "🟩 En circullation ",
            action: function (e, row) {
              window.api.updateReservations(
                row.getData().id,
                "status",
                "En circullation"
              );
              row.getElement().style.backgroundColor = "#bfd834";
            },
          },

          {
            label: "🟧 Incident ",
            action: function (e, row) {
              window.api.updateReservations(
                row.getData().id,
                "status",
                "Incident"
              );
              row.getElement().style.backgroundColor = "#ffc06e";
            },
          },

          {
            separator: true,
          },
          {
            label: "🗑️ Delete Row",
            action: function (e, row) {
              row.delete();
            },
          },
        ];

        /* let cars = [
          "F09",
          "F10",
          "F11",
          "F12",
          "F13",
          "F14",
          "F15",
          "F16",
          "F17",
          "F18",
          "F19",
        ];*/

        clients = clients.map((item) => item.nom);
        // .filter((nom) => nom !== null && nom !== undefined && nom !== "") // Filter out null and undefined values

        console.log(reservations);

        let table = new Tabulator("#table", {
          index: "id",
          data: reservations,
          layout: "fitDataStretch",
          rowContextMenu: rowMenu, //add context menu to rows
          columns: [
            {
              title: "Tel",
              field: "tel",
              sorter: false,
              editor: true,
            },
            {
              title: "Sortie",
              headerHozAlign: "center",
              field: "date_sortie",
              editor: "datetime",
              width: 200,
              editorParams: {
                format: "dd/MM/yyyy 🕖 HH:mm",
              },
            },
            {
              title: "Nom",
              field: "nom",
              editor: "list",
              editorParams: {
                values: clients,
                autocomplete: true,
                allowEmpty: true,
                listOnEmpty: true,
                freetext: true,
              },
            },
            {
              title: "VHCL",
              field: "code",
              editor: "list",
              editorParams: {
                values: cars_codes,
                autocomplete: true,
                allowEmpty: true,
                listOnEmpty: true,
                valuesLookup: true,
                freetext: true,
              },
            },
            {
              title: "Date d'entrer",
              headerHozAlign: "center",
              field: "date_entree",
              editor: "datetime",
              width: 200,
              editorParams: {
                format: "dd/MM/yyyy 🕖 HH:mm",
              },
            },
            {
              title: "Prix",
              field: "prix",
              editor: true,
              formatter: "money",
              formatterParams: {
                precision: 2,
              },
              editor: "number",
              editorParams: {
                min: 0,
                step: 10,
              },
              mutateLink: "montant",
            },
            ,
            {
              title: "Jr",
              field: "n_jr",
              editor: "number",
              editorParams: {
                min: 0,
              },
              mutateLink: "montant",
            },
            {
              title: "Montant",
              field: "montant",
              formatter: "money",
              mutator: function (value, data) {
                return data.prix * data.n_jr;
              },
              bottomCalc: "sum",
              bottomCalcFormatter: "money",
              mutateLink: "credit",
            },
            {
              title: "Caisse",
              field: "caisse",
              bottomCalc: "sum",
              bottomCalcParams: {
                precision: 2,
              },
              bottomCalcFormatter: "money",

              formatter: "money",
              editor: "number",
              editorParams: {
                min: 0,
                step: 10,
              },
              mutateLink: "credit",
            },
            {
              title: "Credit",
              field: "credit",
              mutator: function (value, data) {
                var newValue = data.montant - data.caisse;
                return newValue;
              },
              bottomCalc: "sum",
              bottomCalcFormatter: "money",
              formatter: function (cell, formatterParams) {
                var value = cell.getValue();
                if (value != 0) {
                  cell.getElement().style.backgroundColor = "#de9d9d";
                } else {
                  cell.getElement().style.backgroundColor = "";
                }
                var formattedValue = value.toLocaleString(undefined, {
                  minimumFractionDigits: formatterParams.precision || 2,
                  maximumFractionDigits: formatterParams.precision || 2,
                });
                return formattedValue;
              },
            },
            {
              title: "Observation",
              field: "observation",
              editor: true,
            },
          ],
          rowFormatter: function (row) {
            var rowData = row.getData();
            switch (rowData.status) {
              case "Meknes":
                row.getElement().style.backgroundColor = "#a9d2f0";
                break;
              case "A retourner":
                row.getElement().style.backgroundColor = "white";
                break;
              case "En circullation":
                row.getElement().style.backgroundColor = "#bfd834";
                break;
              case "Incident":
                row.getElement().style.backgroundColor = "#ffc06e";
                break;
              default:
                break;
            }
          },
        });

        table.on("cellEdited", async function (cell) {
          console.log("cell edited");
          let updatedData = {
            [cell.getField()]: cell.getValue(),
          };
          console.log(updatedData);
          try {
            const response = await window.api.updateReservations(
              cell.getRow().getData().id,
              cell.getField(),
              cell.getValue(),
              cell.getRow().getData().nom,
              cell.getRow().getData().tel
            );
            console.log(response);
            response.nom
              ? cell.getRow().update({
                  nom: response.nom,
                  tel: response.tel,
                })
              : null;
          } catch (error) {
            console.error("Error updating reservations:", error);
          }
        });

        table.on("rowAdded", async function (row) {
          try {
            const response = await window.api.storeReservations(); // Call the storeReservations function from the preload script
            console.log(response);
            row.update({
              id: response.id,
              date_sortie: response.date_sortie,
              date_entree: response.date_entree,
            });
          } catch (error) {
            console.error("Error storing reservations:", error);
          }
        });

        table.on("rowDeleted", function (row) {
          window.api.deleteReservations(row.getData().id);
          console.log("row deleted");
        });

        // Function to get reservations by date

        async function getReservationsByDate(month, year) {
          let reservations = await window.api.getReservations(month, year);
          title.innerHTML = numericMonthToName(month) + " " + year;
          table.replaceData(reservations);
        }

        // Add event listeners to the months links in Footer
        const monthsLinks = document.querySelectorAll(".nav-item.footer a");
        monthsLinks.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            console.log(event.target.dataset.month);
            getReservationsByDate(event.target.dataset.month, selectedYear);
            event.target.classList.add("active");
            monthsLinks.forEach(function (link) {
              if (link !== event.target) {
                link.classList.remove("active");
              }
            });
            selectedMonth = event.target.dataset.month;
          });
        });
        // Add event listeners to the years links in Footer
        const yearLinks = document.querySelectorAll(
          ".dropdown-menu.dropdown-menu-dark a"
        );
        yearLinks.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            console.log(event.target.dataset.year);
            getReservationsByDate(selectedMonth, event.target.dataset.year);
            displayedYear.innerHTML = event.target.dataset.year;
            selectedYear = event.target.dataset.year;
          });
        });
        //Islamic Duaa
        const strings = [
          "اللهم اهدنا",
          "اللهم اغفر لي",
          "رب اغفر وارحم",
          "رب اشرح لي صدري",
          "ربنا آتنا في الدنيا حسنة",
          "رب اغفر لي وارحمني",
          "اللهم إني أعوذ بك من العجز والكسل",
          "اللهم اجعل لساني عامرا بذكرك",
          "ربنا لا تزغ قلوبنا",
        ];

        function updateNavbar() {
          const navbarList = document.getElementById("navbarList");
          navbarList.innerHTML = "";
          const randomString =
            strings[Math.floor(Math.random() * strings.length)];

          navbarList.textContent = randomString;
        }

        updateNavbar();

        // Update navbar content every 10 minutes
        setInterval(updateNavbar, 5 * 60 * 1000);

        //REmebering month and year acrosss
        const anchors = document.querySelectorAll("nav a");
        anchors.forEach((anchor) => {
          anchor.addEventListener("click", function (event) {
            event.preventDefault();
            // Get the destination and parameters based on the anchor's ID (or any other method)
            var destination;
            var month;
            var year;
            // Example: Set different destinations and parameters based on the anchor's ID
            switch (this.id) {
              case "index":
                destination = "index.html";
                month = selectedMonth;
                year = selectedYear;
                break;
              case "charges":
                destination = "charges.html";
                month = selectedMonth;
                year = selectedYear;
                break;
              case "credits":
                destination = "credits.html";
                month = selectedMonth;
                year = selectedYear;
                break;
              case "avances":
                destination = "avances.html";
                month = selectedMonth;
                year = selectedYear;
                break;
              case "cars":
                destination = "cars.html";
                month = selectedMonth;
                year = selectedYear;
                break;
              case "clients":
                destination = "clients.html";
                month = selectedMonth;
                year = selectedYear;
                break;
              case "infos":
              destination = "infos.html";
                month = selectedMonth;
                year = selectedYear;
                break;
            }
            // Construct the URL with the parameters
            var url =
              destination +
              "?month=" +
              encodeURIComponent(month) +
              "&year=" +
              encodeURIComponent(year);

            this.href = url;
            console.log(url);
            // Navigate to the URL
            document.location.href = url;
          });
        });
      });
    </script>
  </body>
</html>
