<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Mimoza</title>
    <link href="public/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    <link rel="stylesheet" href="public/tab/dist/css/tabulator_simple.css" />
    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>

  <body class="bg-body-secondary">
    <nav
      class="navbar navbar-expand-sm bg-dark sticky-top"
      data-bs-theme="dark"
    >
      <div class="container-fluid">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo03"
          aria-controls="navbarTogglerDemo03"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggl/e/r-ic/o/n">placeholder</span>
        </button>
        <a class="navbar-brand" href="#"
          ><img
            src="./assets/logo.svg"
            width="100px"
            class="d-none d-xl-block"
          />
        </a>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" aria-current="page" href="index.html"
                ><i class="fa-solid fa-calendar" style="color: #ffffff"></i>
                Reservations |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="charges.html"
                ><i
                  class="fa-solid fa-comment-dollar"
                  style="color: #ffffff"
                ></i>
                Charges |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link active" href="#">
                <i class="fa-solid fa-coins" style="color: #ffffff"></i>

                Cr√©dits |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="#">
                <i
                  class="fa-solid fa-hand-holding-dollar"
                  style="color: #ffffff"
                ></i>
                Avances |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="cars.html">
                <i class="fa-solid fa-car-side" style="color: #ffffff"></i>
                Park |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="clients.html">
                <i class="fa-solid fa-person" style="color: #ffffff"></i>
                Clients |
              </a>
            </li>
          </ul>
          <span class="text-white" id="navbarList"></span>
          <a href="infos.html"
            ><i class="fa-solid fa-circle-info mx-2" style="color: #ffffff"></i
          ></a>
        </div>
      </div>
    </nav>

    <div class="px-4">
      <h1 class="mt-4">Cr√©dits :</h1>
      <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item fs-3 active"></li>
      </ol>
    </div>

    <hr />
    <div class="container-fluid shadow">
      <div id="table"></div>
    </div>

    <div class="container-fluid d-flex justify-content-end mt-2 mb-5">
      <button id="addRow" class="btn btn-success">+ Ajouter</button>
    </div>

    <div class="px-4 mt-5">
      <h1 class="mt-4">Cr√©dits non pay√©s :</h1>
    </div>

    <hr />
    <div class="container-fluid mb-5 shadow">
      <div id="table2"></div>
    </div>
    <hr />

    <div class="accordion accordion-flush mb-5" id="accordionFlushExample">
      <div class="accordion-item bg-body-secondary">
        <h1 class="accordion-header bg-body-secondary">
          <button
            class="accordion-button collapsed bg-body-secondary"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#collapseExample"
            aria-expanded="false"
            aria-controls="collapseExample"
          >
            <span class="h1"
              >Reste du mois pr√©c√©dent :<span id="resteDisplay" class="h3">
                Janvier 2024</span
              ></span
            >
          </button>
        </h1>

        <div
          id="collapseExample"
          class="accordion-collapse collapse"
          data-bs-parent="#collapseExample"
        >
          <div class="accordion-body bg-body-secondary">
            <div class="mt-2 mb-5 mx-2">
              <div id="table3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="fixed-bottom bg-dark px-3 d-flex justify-content-between">
      <ul class="nav nav-underline" data-bs-theme="dark">
        <li class="nav-item footer">
          <a data-month="01" class="nav-link" href="#">Janvier</a>
        </li>
        <li class="nav-item footer">
          <a data-month="02" class="nav-link" href="#">F√©vrier</a>
        </li>
        <li class="nav-item footer">
          <a data-month="03" class="nav-link" href="#">Mars</a>
        </li>
        <li class="nav-item footer">
          <a data-month="04" class="nav-link" href="#">Avril</a>
        </li>
        <li class="nav-item footer">
          <a data-month="05" class="nav-link" href="#">Mai</a>
        </li>
        <li class="nav-item footer">
          <a data-month="06" class="nav-link" href="#">Juin</a>
        </li>
        <li class="nav-item footer">
          <a data-month="07" class="nav-link" href="#">Juillet</a>
        </li>
        <li class="nav-item footer">
          <a data-month="08" class="nav-link" href="#">Ao√ªt</a>
        </li>
        <li class="nav-item footer">
          <a data-month="09" class="nav-link" href="#">Septembre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="10" class="nav-link" href="#">Octobre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="11" class="nav-link" href="#">Novembre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="12" class="nav-link" href="#">D√©cembre</a>
        </li>
      </ul>

      <div class="btn-group dropup">
        <button
          type="button"
          class="btn btn-dark dropdown-toggle"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          2024
        </button>

        <ul class="dropdown-menu dropdown-menu-dark">
          <li><a data-year="2026" class="dropdown-item" href="#">2026</a></li>
          <li><a data-year="2025" class="dropdown-item" href="#">2025</a></li>
          <li><a data-year="2024" class="dropdown-item" href="#">2024</a></li>
          <li><a data-year="2023" class="dropdown-item" href="#">2023</a></li>
        </ul>
      </div>
    </div>

    <script src="public/popper.js"></script>
    <script src="public/bootstrap/dist/js/bootstrap.js"></script>
    <script src="public/luxon.js"></script>
    <script src="public/tab/dist/js/tabulator.js"></script>
    <script>
      const currentDate = new Date();
      const localMonth = currentDate.getMonth() + 1;
      const localYear = currentDate.getFullYear();

      const monthString =
        localMonth < 10 ? "0" + localMonth : localMonth.toString();
      const yearString = localYear.toString();

      let lastMonth = localMonth - 1;
      let lastYear = localYear;
      if (lastMonth === 0) {
        lastMonth = 12;
        lastYear -= 1;
      }
      let lastMonthString =
        lastMonth < 10 ? "0" + lastMonth : lastMonth.toString();

      //Title
      function numericMonthToName(numericMonth) {
        const months = [
          "Janvier",
          "F√©vrier",
          "Mars",
          "Avril",
          "Mai",
          "Juin",
          "Juillet",
          "Ao√ªt",
          "Septembre",
          "Octobre",
          "Novembre",
          "D√©cembre",
        ];
        const index = parseInt(numericMonth, 10) - 1;
        return months[index];
      }
      //title
      const title = document.querySelector(".breadcrumb-item");
      const resteDisplay = document.querySelector("#resteDisplay");

      document.addEventListener("DOMContentLoaded", function () {
        console.log(monthString, yearString);
        let credits = window.api.getCredits(monthString, yearString);
        //for non payed
        let nonPayed = window.api.getNonPayed(monthString, yearString);

        title.innerHTML = numericMonthToName(monthString) + " " + yearString;
        resteDisplay.innerHTML =
          " " + numericMonthToName(monthString - 1) + " " + yearString;

        //Making the current month active
        const activeMonth = document.querySelector(
          `a[data-month="${monthString}"]`
        );
        activeMonth.classList.add("active");
        let selectedMonth = monthString;
        let selectedYear = yearString;
        // Display the selected year in the dropdown
        const displayedYear = document.querySelector(".dropdown-toggle");
        displayedYear.innerHTML = yearString;

        document
          .getElementById("addRow")
          .addEventListener("click", function () {
            table.addRow({
              date_payment: "",
              creditR: "",
              montant: 0,
              date_credit: "",
            });
          });

        var rowMenu = [
          {
            label: "üóëÔ∏è Supprimer la ligne",
            action: function (e, row) {
              row.delete();
            },
          },
        ];

        let clients = nonPayed
          .map((client) => client.nom) // Extract the 'nom' property from each reservation
          .filter((nom) => nom !== null && nom !== undefined && nom !== "") // Filter out null and undefined values
          .filter((value, index, self) => self.indexOf(value) === index); // Filter out duplicate values

        let creditsDates = nonPayed
          .map((credit) => credit.date_sortie.split(" ")[0]) // Extract the date part from each credit's date_sortie
          .filter((date, index, self) => self.indexOf(date) === index) // Filter out duplicate dates
          .filter((date) => date !== null && date !== undefined && date !== ""); // Filter out null, undefined, and empty values

        let table = new Tabulator("#table", {
          index: "id",
          data: credits,
          layout: "fitColumns",
          rowContextMenu: rowMenu,
          columns: [
            {
              title: "Date payment",
              field: "date_payment",
              sorter: true,
              editor: "date",
              width: 200,
              editorParams: {
                format: "dd/MM/yyyy",
              },
              editable: function (cell) {
                if (
                  cell.getRow().getData().date_credit &&
                  cell.getRow().getData().montant &&
                  cell.getRow().getData().date_payment &&
                  cell.getRow().getData().nom
                ) {
                  return false;
                }
                return true;
              },
            },
            {
              title: "Credit R",
              field: "nom",
              editor: "list",
              editorParams: {
                values: clients,
                autocomplete: "true",
                allowEmpty: true,
                listOnEmpty: true,
                freetext: true,
              },
              editable: function (cell) {
                if (
                  cell.getRow().getData().date_credit &&
                  cell.getRow().getData().montant &&
                  cell.getRow().getData().date_payment &&
                  cell.getRow().getData().nom
                ) {
                  return false;
                }
                return true;
              },
            },
            {
              title: "Montant",
              field: "montant",
              formatter: "money",
              editor: "number",
              editorParams: {
                min: 0,
                step: 10,
              },
              bottomCalc: "sum",
              bottomCalcFormatter: "money",
              editable: function (cell) {
                if (
                  cell.getRow().getData().date_credit &&
                  cell.getRow().getData().montant &&
                  cell.getRow().getData().date_payment &&
                  cell.getRow().getData().nom
                ) {
                  return false;
                }
                return true;
              },
            },
            {
              title: "Date De Credit",
              field: "date_credit",
              sorter: true,
              editor: "list",
              editorParams: {
                values: creditsDates,
                autocomplete: "true",
                allowEmpty: true,
                listOnEmpty: true,
                valuesLookup: true,
                freetext: true,
              },
              editable: function (cell) {
                if (
                  cell.getRow().getData().date_credit &&
                  cell.getRow().getData().montant &&
                  cell.getRow().getData().date_payment &&
                  cell.getRow().getData().nom
                ) {
                  return false;
                }
                return true;
              },
            },
          ],
        });

        table.on("cellEdited", async function (cell) {
          console.log("cell edited");
          let updatedData = {
            [cell.getField()]: cell.getValue(),
          };
          console.log(updatedData);

          try {
            const response = await window.api.updateCredits(
              cell.getRow().getData().id,
              cell.getField(),
              cell.getValue(),
              cell.getRow().getData().date_credit,
              cell.getRow().getData().montant,
              cell.getRow().getData().idclient,
              cell.getRow().getData().date_payment
            );
            console.log(response);
            response.idclient
              ? cell.getRow().update({ idclient: response.idclient })
              : null;
            let nonPayed = await getCreditsByDate(selectedMonth, selectedYear);
          } catch (error) {
            console.error("Error updating reservations:", error);
          }
        });

        table.on("rowAdded", async function (row) {
          try {
            const response = await window.api.storeCredits(); // Call the storeReservations function from the preload script
            console.log(response);
            row.update({
              id: response.id,
              date_payment: response.date_payment,
            });
          } catch (error) {
            console.error("Error storing reservations:", error);
          }
        });

        table.on("rowDeleted", async function (row) {
          try {
            const response = await window.api.deleteCredits(
              row.getData().id,
              row.getData().date_credit,
              row.getData().montant,
              row.getData().idclient,
              row.getData().date_payment
            );
            let nonPayed = await window.api.getNonPayed(
              monthString,
              yearString
            );
            table2.replaceData(nonPayed);
            console.log("row deleted");
          } catch (error) {
            console.error("Error updating reservations:", error);
          }
        });

        // Function to get reservations by date

        async function getCreditsByDate(month, year) {
          let credits = await window.api.getCredits(month, year);
          let nonPayed = await window.api.getNonPayed(month, year);
          let resteData = await window.api.getReste(lastMonthString, lastYear);
          title.innerHTML = numericMonthToName(month) + " " + year;
          resteDisplay.innerHTML =
            " " + numericMonthToName(lastMonth) + " " + lastYear;
          let clients = nonPayed
            .map((res) => res.nom) // Extract the 'nom' property from each reservation
            .filter((nom) => nom !== null && nom !== undefined && nom !== "") // Filter out null and undefined values
            .filter((value, index, self) => self.indexOf(value) === index); // Filter out duplicate values

          let creditsDates = nonPayed
            .map((credit) => credit.date_sortie.split(" ")[0]) // Extract the date part from each credit's date_sortie
            .filter((date, index, self) => self.indexOf(date) === index) // Filter out duplicate dates
            .filter(
              (date) => date !== null && date !== undefined && date !== ""
            ); // Filter out null, undefined, and empty values

          table.replaceData(credits);
          table2.replaceData(nonPayed);
          table3.replaceData(resteData);
          table.updateColumnDefinition("nom", {
            editorParams: { values: clients },
          });
          table.updateColumnDefinition("date_credit", {
            editorParams: { values: creditsDates },
          });
        }

        // Add event listeners to the months links in Footer
        const monthsLinks = document.querySelectorAll(".nav-item.footer a");
        monthsLinks.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            console.log(event.target.dataset.month);
            getCreditsByDate(event.target.dataset.month, selectedYear);
            event.target.classList.add("active");
            monthsLinks.forEach(function (link) {
              if (link !== event.target) {
                link.classList.remove("active");
              }
            });
            selectedMonth = event.target.dataset.month;

            lastMonth = selectedMonth - 1;
            lastYear = selectedYear;
            if (lastMonth === 0) {
              lastMonth = 12;
              lastYear -= 1;
            }
            lastMonthString =
              lastMonth < 10 ? "0" + lastMonth : lastMonth.toString();
          });
        });

        const yearLinks = document.querySelectorAll(
          ".dropdown-menu.dropdown-menu-dark a"
        );
        yearLinks.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            console.log(event.target.dataset.year);
            getCreditsByDate(selectedMonth, event.target.dataset.year);
            displayedYear.innerHTML = event.target.dataset.year;
            selectedYear = event.target.dataset.year;

            lastYear = selectedMonth === "01" ? selectedYear - 1 : selectedYear;
          });
        });

        //Non payed Table
        let table2 = new Tabulator("#table2", {
          index: "id",
          data: nonPayed,
          layout: "fitDataStretch",
          rowFormatterPrint: false, //disable standard formatter when printing
          columns: [
            {
              title: "Tel",
              field: "tel",
              sorter: false,
            },
            {
              title: "Sortie",
              headerHozAlign: "center",
              field: "date_sortie",
              width: 200,
            },
            {
              title: "Nom",
              field: "nom",
            },
            {
              title: "VHCL",
              field: "car_code",
            },
            {
              title: "Date d'entrer",
              headerHozAlign: "center",
              field: "date_entree",
              width: 200,
            },
            {
              title: "Prix",
              field: "prix",
              formatter: "money",
            },
            ,
            {
              title: "Jr",
              field: "n_jr",
            },
            {
              title: "Montant",
              field: "montant",
              formatter: "money",
            },
            {
              title: "Caisse",
              field: "caisse",
              formatter: "money",
            },
            {
              title: "Credit",
              field: "credit",
              bottomCalc: "sum",
              bottomCalcFormatter: "money",
              formatter: function (cell, formatterParams) {
                var value = cell.getValue();
                if (value != 0) {
                  cell.getElement().style.backgroundColor = "#de9d9d";
                }
                var formattedValue = value.toLocaleString(undefined, {
                  minimumFractionDigits: formatterParams.precision || 2,
                  maximumFractionDigits: formatterParams.precision || 2,
                });
                return formattedValue;
              },
            },
            {
              title: "Observation",
              field: "observation",
            },
          ],
          rowFormatter: function (row) {
            var rowData = row.getData();
            switch (rowData.status) {
              case "Meknes":
                row.getElement().style.backgroundColor = "#a9d2f0";
                break;
              case "A retourner":
                row.getElement().style.backgroundColor = "white";
                break;
              case "En circullation":
                row.getElement().style.backgroundColor = "#bfd834";
                break;
              case "Incident":
                row.getElement().style.backgroundColor = "#ffc06e";
                break;
              default:
                break;
            }
          },
        });

        //Islamic Duaa
        const strings = [
          "ÿßŸÑŸÑŸáŸÖ ÿßŸáÿØŸÜÿß",
          "ÿßŸÑŸÑŸáŸÖ ÿßÿ∫ŸÅÿ± ŸÑŸä",
          "ÿ±ÿ® ÿßÿ∫ŸÅÿ± Ÿàÿßÿ±ÿ≠ŸÖ",
          "ÿ±ÿ® ÿßÿ¥ÿ±ÿ≠ ŸÑŸä ÿµÿØÿ±Ÿä",
          "ÿ±ÿ®ŸÜÿß ÿ¢ÿ™ŸÜÿß ŸÅŸä ÿßŸÑÿØŸÜŸäÿß ÿ≠ÿ≥ŸÜÿ©",
          "ÿ±ÿ® ÿßÿ∫ŸÅÿ± ŸÑŸä Ÿàÿßÿ±ÿ≠ŸÖŸÜŸä",
          "ÿßŸÑŸÑŸáŸÖ ÿ•ŸÜŸä ÿ£ÿπŸàÿ∞ ÿ®ŸÉ ŸÖŸÜ ÿßŸÑÿπÿ¨ÿ≤ ŸàÿßŸÑŸÉÿ≥ŸÑ",
          "ÿßŸÑŸÑŸáŸÖ ÿßÿ¨ÿπŸÑ ŸÑÿ≥ÿßŸÜŸä ÿπÿßŸÖÿ±ÿß ÿ®ÿ∞ŸÉÿ±ŸÉ",
          "ÿ±ÿ®ŸÜÿß ŸÑÿß ÿ™ÿ≤ÿ∫ ŸÇŸÑŸàÿ®ŸÜÿß",
        ];

        function updateNavbar() {
          const navbarList = document.getElementById("navbarList");
          navbarList.innerHTML = "";
          const randomString =
            strings[Math.floor(Math.random() * strings.length)];

          navbarList.textContent = randomString;
        }

        updateNavbar();

        // Update navbar content every 10 minutes
        setInterval(updateNavbar, 5 * 60 * 1000);

        // Reste du mois pr√©c√©dent
        console.log("SELECTEDMONTH", selectedMonth);
        console.log("LAST", lastMonth);

        const resteData = window.api.getReste(lastMonthString, lastYear);
        console.log(resteData);

        const table3 = new Tabulator("#table3", {
          data: resteData,
          layout: "fitDataTable",
          columns: [
            {
              title: "Label",
              field: "label",
              formatter: function (cell) {
                const count = cell.getRow().getData().count;
                const val = cell.getValue();
                return `  <b> ${val} (${count}) </b>    `;
              },
            },
            { title: "Count", field: "count", visible: false, width: 200 },
            { title: "Value", field: "value", bottomCalc: "sum", width: 200 },
          ],
        });
      });
    </script>
  </body>
</html>
