<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Mimoza</title>
    <link rel="stylesheet" href="public/tab/dist/css/tabulator_simple.css" />
    <link href="public/bootstrap/dist/css/bootstrap.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body class="bg-body-secondary">
    <nav
      class="navbar navbar-expand-sm bg-dark sticky-top"
      data-bs-theme="dark"
    >
      <div class="container-fluid">
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarTogglerDemo03"
          aria-controls="navbarTogglerDemo03"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggl/e/r-ic/o/n">placeholder</span>
        </button>
        <a class="navbar-brand" href="#"
          ><img
            src="./assets/logo.svg"
            width="100px"
            class="d-none d-xl-block"
          />
        </a>
        <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" aria-current="page" href="index.html"
                ><i class="fa-solid fa-calendar" style="color: #ffffff"></i>
                Reservations |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="charges.html"
                ><i
                  class="fa-solid fa-comment-dollar"
                  style="color: #ffffff"
                ></i>
                Charges |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="credits.html">
                <i class="fa-solid fa-coins" style="color: #ffffff"></i>

                Crédits |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link active" href="#">
                <i
                  class="fa-solid fa-hand-holding-dollar"
                  style="color: #ffffff"
                ></i>
                Avances |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="cars.html">
                <i class="fa-solid fa-car-side" style="color: #ffffff"></i>
                Park |
              </a>
            </li>
            <li class="nav-item d-flex align-items-center">
              <a class="nav-link" href="clients.html">
                <i class="fa-solid fa-person" style="color: #ffffff"></i>
                Clients |
              </a>
            </li>
          </ul>
          <span class="text-white" id="navbarList"></span>
          <a href="infos.html"
            ><i class="fa-solid fa-circle-info mx-2" style="color: #ffffff"></i
          ></a>
        </div>
      </div>
    </nav>

    <div class="px-4">
      <h1 class="mt-4">Avances :</h1>
      <ol class="breadcrumb mb-4 d-block">
        <li class="breadcrumb-item fs-3 active d-block"></li>
      </ol>
    </div>

    <hr />
    <div class="container-fluid shadow">
      <div id="table" class="container-fluid"></div>
    </div>

    <div class="container-fluid d-flex justify-content-end mt-2 mb-5">
      <button id="addRow1" class="btn btn-success">+ Ajouter</button>
    </div>

    <div class="px-4">
      <h1 class="mt-4">Verssements :</h1>
      <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item fs-3 active"></li>
      </ol>
    </div>

    <hr />
    <div class="container-fluid shadow">
      <div id="table2" class="container-fluid"></div>
    </div>

    <div class="container-fluid d-flex justify-content-end mt-2 mb-5">
      <button id="addRow2" class="btn btn-success">+ Ajouter</button>
    </div>

    <div class="px-4">
      <h1 class="mt-4">Driss :</h1>
      <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item fs-3 active"></li>
      </ol>
    </div>

    <hr />
    <div class="container-fluid shadow">
      <div id="table3" class="container-fluid"></div>
    </div>

    <div class="container-fluid d-flex justify-content-end mt-2 mb-5">
      <button id="addRow3" class="btn btn-success">+ Ajouter</button>
    </div>

    <div class="fixed-bottom bg-dark px-3 d-flex justify-content-between">
      <ul class="nav nav-underline" data-bs-theme="dark">
        <li class="nav-item footer">
          <a data-month="01" class="nav-link" href="#">Janvier</a>
        </li>
        <li class="nav-item footer">
          <a data-month="02" class="nav-link" href="#">Février</a>
        </li>
        <li class="nav-item footer">
          <a data-month="03" class="nav-link" href="#">Mars</a>
        </li>
        <li class="nav-item footer">
          <a data-month="04" class="nav-link" href="#">Avril</a>
        </li>
        <li class="nav-item footer">
          <a data-month="05" class="nav-link" href="#">Mai</a>
        </li>
        <li class="nav-item footer">
          <a data-month="06" class="nav-link" href="#">Juin</a>
        </li>
        <li class="nav-item footer">
          <a data-month="07" class="nav-link" href="#">Juillet</a>
        </li>
        <li class="nav-item footer">
          <a data-month="08" class="nav-link" href="#">Août</a>
        </li>
        <li class="nav-item footer">
          <a data-month="09" class="nav-link" href="#">Septembre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="10" class="nav-link" href="#">Octobre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="11" class="nav-link" href="#">Novembre</a>
        </li>
        <li class="nav-item footer">
          <a data-month="12" class="nav-link" href="#">Décembre</a>
        </li>
      </ul>

      <div class="btn-group dropup">
        <button
          type="button"
          class="btn btn-dark dropdown-toggle"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          2024
        </button>
        <ul class="dropdown-menu dropdown-menu-dark">
          <li><a data-year="2026" class="dropdown-item" href="#">2026</a></li>
          <li><a data-year="2025" class="dropdown-item" href="#">2025</a></li>
          <li><a data-year="2024" class="dropdown-item" href="#">2024</a></li>
          <li><a data-year="2023" class="dropdown-item" href="#">2023</a></li>
        </ul>
      </div>
    </div>

    <script src="public/popper.js"></script>
    <script src="public/bootstrap/dist/js/bootstrap.js"></script>
    <script src="public/luxon.js"></script>
    <script src="public/tab/dist/js/tabulator.js"></script>

    <script>
      const currentDate = new Date();
      const localMonth = currentDate.getMonth() + 1;
      const localYear = currentDate.getFullYear();

      const monthString =
        localMonth < 10 ? "0" + localMonth : localMonth.toString();
      const yearString = localYear.toString();

      function numericMonthToName(numericMonth) {
        const months = [
          "Janvier",
          "Février",
          "Mars",
          "Avril",
          "Mai",
          "Juin",
          "Juillet",
          "Août",
          "Septembre",
          "Octobre",
          "Novembre",
          "Décembre",
        ];
        const index = parseInt(numericMonth, 10) - 1;
        return months[index];
      }

      document.addEventListener("DOMContentLoaded", function () {
        const titles = document.querySelectorAll(".breadcrumb-item");
        titles.forEach((title) => {
          title.innerHTML = numericMonthToName(monthString) + " " + yearString;
        });

        let avances = window.api.getAvances(monthString, yearString);
        console.log(avances);
        let avance = [];
        let verssements = [];
        let driss = [];
        avances.forEach((el) => {
          if (el.type_avance === "avance") {
            avance.push(el);
          } else if (el.type_avance === "verssement") {
            verssements.push(el);
          } else {
            driss.push(el);
          }
        });
        //Making the current month active
        const activeMonth = document.querySelector(
          `a[data-month="${monthString}"]`
        );
        activeMonth.classList.add("active");
        let selectedMonth = monthString;
        let selectedYear = yearString;
        // Display the selected year in the dropdown
        const displayedYear = document.querySelector(".dropdown-toggle");
        displayedYear.innerHTML = yearString;

        console.log(avance, verssements, driss);

        document
          .getElementById("addRow1")
          .addEventListener("click", function () {
            table.addRow({});
          });
        document
          .getElementById("addRow2")
          .addEventListener("click", function () {
            table2.addRow({});
          });
        document
          .getElementById("addRow3")
          .addEventListener("click", function () {
            table3.addRow({});
          });

        // Tabulator
        let types = ["VERSEMENT", "ESPECE"];

        var rowMenu = [
          {
            label: "<i class='fas fa-trash'></i> Delete Row",
            action: function (e, row) {
              row.delete();
            },
          },
        ];

        const table = new Tabulator("#table", {
          data: avance,
          layout: "fitColumns",
          rowContextMenu: rowMenu,
          index: "id",
          columns: [
            {
              title: "Employé",
              field: "nom",
              editor: "list",
              editorParams: {
                values: ["Med", "Said", "Zakia", "Hafid", "Abdo"],
                autocomplete: true,
                allowEmpty: true,
                listOnEmpty: true,
                freetext: true,
              },
            },
            {
              title: "Montant",
              field: "montant",
              editor: "number",
              editorParams: {
                step: 100,
                min: 0,
              },
              formatter: "money",
              bottomCalc: "sum",
              bottomCalcParams: {
                precision: 2,
              },
              bottomCalcFormatter: "money",
            },
            {
              title: "Observation",
              field: "observation",
              editor: "input",
            },
          ],
        });

        const table2 = new Tabulator("#table2", {
          data: verssements,
          layout: "fitColumns",
          rowContextMenu: rowMenu,
          index: "id",
          columns: [
            {
              title: "Date",
              field: "date_avance",
              editor: "date",
              editorParams: {
                format: "dd/MM/yyyy",
              },
            },
            {
              title: "Versement",
              field: "observation",
              editor: "input",
            },
            {
              title: "Montant",
              field: "montant",
              editor: "number",
              editorParams: {
                step: 100,
                min: 0,
              },
              formatter: "money",
              bottomCalc: "sum",
              bottomCalcParams: {
                precision: 2,
              },
              bottomCalcFormatter: "money",
            },
          ],
        });

        const table3 = new Tabulator("#table3", {
          data: driss,
          layout: "fitColumns",
          rowContextMenu: rowMenu,
          index: "id",
          columns: [
            {
              title: "Date",
              field: "date_avance",
              editor: "date",
              editorParams: {
                format: "dd/MM/yyyy",
              },
            },
            {
              title: "Versement",
              field: "observation",
              editor: "input",
            },
            {
              title: "Montant",
              field: "montant",
              editor: "number",
              editorParams: {
                step: 100,
                min: 0,
              },
              formatter: "money",
              bottomCalc: "sum",
              bottomCalcParams: {
                precision: 2,
              },
              bottomCalcFormatter: "money",
            },
          ],
        });

        // Define the event listener functions separately
        async function cellEditedHandler(cell) {
          try {
            const response = await window.api.updateAvances(
              cell.getRow().getData().id,
              cell.getField(),
              cell.getValue()
            );
            console.log(response);
          } catch (error) {
            console.error("Error updating avances:", error);
          }
        }

        function rowDeletedHandler(row) {
          window.api.deleteAvances(row.getData().id);
          console.log("row deleted");
        }

        table.on("rowAdded", async function (row) {
          try {
            const response = await window.api.storeAvances("avance");
            console.log(response);
            row.update({
              id: response.id,
              date_avance: response.date_avance,
              montant: response.montant,
            });
          } catch (error) {
            console.error("Error storing avances:", error);
          }
        });
        table.on("cellEdited", cellEditedHandler);
        table.on("rowDeleted", rowDeletedHandler);

        table2.on("rowAdded", async function (row) {
          try {
            const response = await window.api.storeAvances("verssement");
            console.log(response);
            row.update({
              id: response.id,
              date_avance: response.date_avance,
              montant: response.montant,
            });
          } catch (error) {
            console.error("Error storing avances:", error);
          }
        });
        table2.on("cellEdited", cellEditedHandler);
        table2.on("rowDeleted", rowDeletedHandler);

        table3.on("rowAdded", async function (row) {
          try {
            const response = await window.api.storeAvances("driss");
            console.log(response);
            row.update({
              id: response.id,
              date_avance: response.date_avance,
              montant: response.montant,
            });
          } catch (error) {
            console.error("Error storing avances:", error);
          }
        });
        table3.on("cellEdited", cellEditedHandler);
        table3.on("rowDeleted", rowDeletedHandler);

        // Function to get reservations by date

        async function getAvancesByDate(month, year) {
          let avances = await window.api.getAvances(month, year);
          //      title.innerHTML = numericMonthToName(month) + " " + year;
          avance = [];
          verssements = [];
          driss = [];
          avances.forEach((el) => {
            if (el.type_avance === "avance") {
              avance.push(el);
            } else if (el.type_avance === "verssement") {
              verssements.push(el);
            } else {
              driss.push(el);
            }
          });
          table.replaceData(avance);
          table2.replaceData(verssements);
          table3.replaceData(driss);
        }

        // Add event listeners to the months links in Footer
        const monthsLinks = document.querySelectorAll(".nav-item.footer a");
        monthsLinks.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            console.log(event.target.dataset.month);
            getAvancesByDate(event.target.dataset.month, selectedYear);
            event.target.classList.add("active");
            monthsLinks.forEach(function (link) {
              if (link !== event.target) {
                link.classList.remove("active");
              }
            });
            selectedMonth = event.target.dataset.month;
          });
        });
        // Add event listeners to the years links in Footer
        const yearLinks = document.querySelectorAll(
          ".dropdown-menu.dropdown-menu-dark a"
        );
        yearLinks.forEach(function (link) {
          link.addEventListener("click", function (event) {
            event.preventDefault();
            console.log(event.target.dataset.year);
            getAvancesByDate(selectedMonth, event.target.dataset.year);
            displayedYear.innerHTML = event.target.dataset.year;
            selectedYear = event.target.dataset.year;
          });
        });
        //Islamic Duaa
        const strings = [
          "اللهم اهدنا",
          "اللهم اغفر لي",
          "رب اغفر وارحم",
          "رب اشرح لي صدري",
          "ربنا آتنا في الدنيا حسنة",
          "رب اغفر لي وارحمني",
          "اللهم إني أعوذ بك من العجز والكسل",
          "اللهم اجعل لساني عامرا بذكرك",
          "ربنا لا تزغ قلوبنا",
        ];

        function updateNavbar() {
          const navbarList = document.getElementById("navbarList");
          navbarList.innerHTML = "";
          const randomString =
            strings[Math.floor(Math.random() * strings.length)];

          navbarList.textContent = randomString;
        }

        updateNavbar();

        // Update navbar content every 10 minutes
        setInterval(updateNavbar, 5 * 60 * 1000);
      });
    </script>
  </body>
</html>
